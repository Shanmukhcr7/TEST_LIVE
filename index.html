<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Star English</title>

  <!-- Shaka Player -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous">

  <style>
    /* Minimal, non-duplicated CSS */
    :root {
      --bg: #000;
      --muted: #d1d5db;
      --viewer-bg: rgba(0,0,0,0.7);
      --viewer-color: #00ff00;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; background: var(--bg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; overflow: hidden; }

    .shaka-video-container {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      max-height: 100vh;
      background: #000;
      object-fit: contain;
    }

    /* Hide Shaka spinner */
    .shaka-spinner-container, .shaka-spinner, .shaka-spinner-svg {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

    /* Viewer count */
    #viewerCount {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--viewer-bg);
      color: var(--viewer-color);
      padding: 8px 14px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 20px;
      z-index: 1200;
      pointer-events: none;
      text-align: center;
    }

    /* Canvas/overlay if Shaka requires it */
    .shaka-canvas-container { display: none; }
  </style>
</head>
<body>

  <!-- Viewer count -->
  <div id="viewerCount">Viewers: 0</div>

  <!-- Shaka player container -->
  <div class="shaka-video-container" data-shaka-player-container shaka-controls="true">
    <div class="shaka-video-container shaka-video" data-shaka-player>
      <!-- keep your blob src or replace with the actual source -->
      <video id="playerVideo" autoplay playsinline preload="metadata" poster="" src="blob:https://matcheslinks-eaa.pages.dev/0a159ba2-7df0-461b-ac35-8ef3d279407a" class="shaka-video"></video>
    </div>
    <canvas class="shaka-canvas-container" aria-hidden="true"></canvas>
  </div>

  <script>
    /********** WebSocket Viewer Count **********/
    (function setupViewerWS(){
      const viewerCountEl = document.getElementById('viewerCount');
      try {
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${protocol}://${window.location.host}`);

        ws.onopen = () => console.log('Viewer WS connected');
        ws.onmessage = (ev) => {
          try {
            const data = JSON.parse(ev.data);
            if (data && data.type === 'viewerCount' && typeof data.count === 'number') {
              viewerCountEl.textContent = `Viewers: ${data.count}`;
            }
          } catch (err) {
            console.error('WS parse error', err);
          }
        };
        ws.onerror = (e) => console.warn('Viewer WS error', e);
        ws.onclose = () => console.log('Viewer WS closed');
      } catch (e) {
        console.warn('Viewer WS setup failed', e);
      }
    })();
  </script>

  <script>
    /**********************************************
     * HDNEA Cookie refresh + Shaka Player setup
     **********************************************/
    (async function(){
      if (!window.shaka) {
        console.error('Shaka library not loaded');
        return;
      }
      shaka.polyfill.installAll();

      if (!shaka.Player.isBrowserSupported()) {
        console.error('Browser not supported by Shaka');
        return;
      }

      // HDNEA cookie source and refresh interval
      const COOKIE_URL = 'https://matcheslinks-eaa.pages.dev/cookie.txt';
      const COOKIE_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
      let cookieHeader = '';

      async function fetchAndUpdateCookie(){
        try {
          const resp = await fetch(COOKIE_URL + '?t=' + Date.now(), { cache: 'no-store' });
          if (!resp.ok) throw new Error('cookie fetch failed: ' + resp.status);
          const txt = (await resp.text()).trim();
          cookieHeader = txt;
          console.log('HDNEA fetched');
          return cookieHeader;
        } catch (err) {
          console.warn('HDNEA fetch error:', err);
          if (cookieHeader) return cookieHeader; // continue using previous
          throw err;
        }
      }

      // initial fetch (best-effort)
      try { await fetchAndUpdateCookie(); } catch (e) { console.warn('initial cookie fetch failed', e); }

      // schedule refresh
      setInterval(fetchAndUpdateCookie, COOKIE_REFRESH_INTERVAL);

      // Shaka init
      const video = document.getElementById('playerVideo');
      const player = new shaka.Player(video);
      const container = document.querySelector('.shaka-video-container');
      const ui = new shaka.ui.Overlay(player, container, video);

      // UI config (keeps the controls you used)
      ui.configure({
        controlPanelElements: [
          'play_pause', 'time_and_duration', 'mute', 'volume',
          'spacer', 'language', 'captions', 'picture_in_picture',
          'quality', 'fullscreen'
        ],
        volumeBarColors: { base: 'rgba(63, 187, 1, 1)', level: 'rgb(255, 69, 0)' },
        seekBarColors: { base: 'rgb(41, 41, 163)', buffered: 'rgb(35, 99, 3)', played: 'rgba(63, 187, 1, 1)' }
      });

      // DRM & stream (preserved from your original)
      const drmConfig = {
        clearKeys: {
          "9457eb90129456fa8ea95e10ba4ac51e": "e620a970cea474c491ac78ae71a4d764"
        }
      };
      const streamUrl = "https://jiotvmblive.cdn.jio.com/bpk-tv/Star_Sports_HD2_BTS/output/index.mpd";

      player.configure({
        drm: drmConfig,
        streaming: {
          lowLatencyMode: true,
          bufferingGoal: 15,
          rebufferingGoal: 2,
          bufferBehind: 15,
          retryParameters: { timeout: 10000, maxAttempts: 5, baseDelay: 300, backoffFactor: 1.2 },
          segmentRequestTimeout: 8000,
          segmentPrefetchLimit: 2,
          useNativeHlsOnSafari: true
        },
        manifest: { retryParameters: { timeout: 8000, maxAttempts: 3 } }
      });

      // Inject headers & append cookie param where needed
      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        // Attach headers expected by origin
        request.headers['Referer'] = 'https://www.jiotv.com/';
        request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
        if (cookieHeader) request.headers['Cookie'] = cookieHeader;

        // Append cookie string (e.g. __hdnea__=...) to manifest/segment URIs if missing
        if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
             type === shaka.net.NetworkingEngine.RequestType.SEGMENT) &&
            request.uris && request.uris[0] && !request.uris[0].includes('__hdnea__=')) {
          const separator = request.uris[0].includes('?') ? '&' : '?';
          request.uris[0] = request.uris[0] + separator + cookieHeader;
        }
      });

      try {
        await player.load(streamUrl);
        console.log('Shaka loaded stream');
      } catch (err) {
        console.error('Shaka load error', err);
      }

      // expose player for debugging if needed
      window.__shakaPlayer = player;

    })();
  </script>
</body>
</html>
